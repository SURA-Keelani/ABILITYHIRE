<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>مراكز ذوي الاحتياجات الخاصة في الأردن</title>
  <style>
    body { margin: 0; font-family: sans-serif; background-color: #121212; color: white; }
    #map { height: 90vh; width: 100%; }
    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #1f1f1f;
    }
    select, button {
      padding: 10px;
      background-color: #2c2c2c;
      color: white;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <label for="filter">تصفية حسب نوع الإعاقة:</label>
      <select id="filter">
        <option value="all">الكل</option>
        <option value="حركي">حركية</option>
        <option value="بصري">بصرية</option>
        <option value="سمعي">سمعية</option>
        <option value="معرفي">معرفية</option>
      </select>
    </div>
    <button onclick="showNearest()">أقرب مركز إليك</button>
  </div>

  <div id="map"></div>

  <script>
    let map, userMarker;
    let userLocation;
    let markers = [];
    let centers = [];

    async function fetchCenters() {
      try {
        const response = await fetch('/api/accessible_locations');
        const data = await response.json();
        if (data.locations) {
          centers = data.locations.map(loc => ({
            id: loc.id,
            name: loc.name,
            lat: loc.latitude,
            lng: loc.longitude,
            types: loc.features,
            phone: loc.phone_number,
            openingHours: loc.opening_hours,
            address: loc.address
          }));
          renderCenters();
        } else {
          alert('خطأ في تحميل بيانات المراكز.');
        }
      } catch (error) {
        alert('فشل في جلب بيانات المراكز.');
        console.error(error);
      }
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 8,
        center: { lat: 31.9539, lng: 35.9106 },
        styles: [{ elementType: 'geometry', stylers: [{ color: '#1f1f1f' }] }]
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          userMarker = new google.maps.Marker({
            position: userLocation,
            map: map,
            icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            title: "موقعك الحالي"
          });

          fetchCenters();
        });
      } else {
        fetchCenters();
      }

      document.getElementById("filter").addEventListener("change", renderCenters);
    }

    function renderCenters() {
      markers.forEach(m => m.setMap(null));
      markers = [];
      const selected = document.getElementById("filter").value;

      centers.forEach(center => {
        if (selected === "all" || center.types.includes(selected)) {
          const marker = new google.maps.Marker({
            position: { lat: center.lat, lng: center.lng },
            map: map,
            title: center.name,
            icon: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
          });

          const infoContent = `
            <div>
              <b>${center.name}</b><br>
              <b>أنواع الإعاقات:</b> ${(center.types && center.types.length > 0) ? center.types.join(", ") : 'غير متوفر'}<br>
              ${center.phone ? `<b>رقم الهاتف:</b> ${center.phone}<br>` : '<b>رقم الهاتف:</b> غير متوفر<br>'}
              ${center.openingHours ? `<b>ساعات العمل:</b> ${center.openingHours}<br>` : '<b>ساعات العمل:</b> غير متوفر<br>'}
              ${center.address ? `<b>العنوان:</b> ${center.address}` : '<b>العنوان:</b> غير متوفر'}
            </div>
          `;

          const infoWindow = new google.maps.InfoWindow({
            content: infoContent
          });

          marker.addListener("click", () => infoWindow.open(map, marker));
          markers.push(marker);

          // Geofencing alert
          if (userLocation) {
            const dist = google.maps.geometry.spherical.computeDistanceBetween(
              new google.maps.LatLng(userLocation),
              new google.maps.LatLng(center.lat, center.lng)
            );
            if (dist < 5000) {
              alert(`أنت قريب من: ${center.name}`);
            }
          }
        }
      });
    }

    function showNearest() {
      if (!userLocation) {
        alert("لم يتم تحديد موقعك بعد.");
        return;
      }
      let nearest = null;
      let minDist = Infinity;

      centers.forEach(center => {
        const dist = google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(userLocation),
          new google.maps.LatLng(center.lat, center.lng)
        );
        if (dist < minDist) {
          minDist = dist;
          nearest = center;
        }
      });

      if (nearest) {
        map.setCenter({ lat: nearest.lat, lng: nearest.lng });
        map.setZoom(14);
        alert(`أقرب مركز إليك هو: ${nearest.name}`);
      }
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDD2fG9hoxvssB17d1w2oOrtzJLXE9dIo8&libraries=geometry&callback=initMap">
  </script>
</body>
</html>
