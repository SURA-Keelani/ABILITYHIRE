{% extends 'base.html' %}

{% block content %}
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 10px;
    }
    #sidebar {
        position: absolute;
        top: 80px;
        left: 10px;
        width: 300px;
        max-height: 520px;
        overflow-y: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        padding: 10px;
        z-index: 10;
        font-family: Arial, sans-serif;
    }
    #sidebar h2 {
        margin-top: 0;
        font-size: 18px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }
    #sidebar ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }
    #sidebar li {
        padding: 8px 5px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    #sidebar li:hover {
        background-color: #f0f0f0;
    }
    #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9);
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-size: 18px;
        display: none;
        z-index: 20;
    }
    #search-input {
        width: 250px;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
        margin-right: 10px;
    }
    #locate-btn {
        padding: 8px 15px;
        border-radius: 6px;
        border: none;
        background-color: #4285F4;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    #locate-btn:hover {
        background-color: #357ae8;
    }
    #controls {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }
    /* RTL support */
    body.rtl #sidebar {
        left: auto;
        right: 10px;
    }
    body.rtl #controls {
        flex-direction: row-reverse;
    }
</style>

<h1 id="pageTitle">Accessibility Map</h1>
<div id="controls">
    <input id="search-input" type="text" placeholder="البحث التلقائي" />
    <button id="locate-btn">تحديد موقعي</button>
</div>

<!-- Disability Type Filter UI -->
<div id="filter-controls" style="margin: 10px 0; font-family: Arial, sans-serif;">
    <label><input type="checkbox" class="disability-filter" value="visual" checked> بصري (Visual)</label>
    <label><input type="checkbox" class="disability-filter" value="mobility" checked> حركي (Mobility)</label>
    <label><input type="checkbox" class="disability-filter" value="hearing" checked> سمعي (Hearing)</label>
    <label><input type="checkbox" class="disability-filter" value="cognitive" checked> معرفي (Cognitive)</label>
</div>

<div id="map"></div>
<div id="sidebar">
    <h2>مراكز الدعم</h2>
    <ul id="locations-list"></ul>
</div>
<div id="loading">جارٍ تحميل المراكز...</div>
<div id="directions-panel"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAtdrNZT1dNgQLDT6wy_ZZsLil795tupKw&libraries=places&callback=initMap" async defer></script>
<script src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"></script>

<script>
    let currentLang = localStorage.getItem('abilityHireLang') || 'en';

    function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem('abilityHireLang', lang);
        applyLanguage();
    }

    function applyLanguage() {
        document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
        if (currentLang === 'ar') {
            document.body.classList.add('rtl');
        } else {
            document.body.classList.remove('rtl');
        }
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.toggle('selected', btn.dataset.lang === currentLang);
        });

        const translations = {
            en: {
                pageTitle: "Accessibility Map",
                searchInputPlaceholder: "Search Autocomplete",
                locateBtn: "Locate Me",
                loadingText: "Loading centers...",
                sidebarTitle: "Support Centers"
            },
            ar: {
                pageTitle: "خريطة الوصولية",
                searchInputPlaceholder: "البحث التلقائي",
                locateBtn: "تحديد موقعي",
                loadingText: "جارٍ تحميل المراكز...",
                sidebarTitle: "مراكز الدعم"
            }
        };

        const t = translations[currentLang];
        Object.keys(t).forEach(key => {
            const element = document.getElementById(key);
            if (element) element.textContent = t[key];
        });

        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.placeholder = t.searchInputPlaceholder;

        const locateBtn = document.getElementById('locate-btn');
        if (locateBtn) locateBtn.textContent = t.locateBtn;

        const sidebarTitle = document.querySelector('#sidebar h2');
        if (sidebarTitle) sidebarTitle.textContent = t.sidebarTitle;

        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) loadingDiv.textContent = t.loadingText;
    }

    window.addEventListener('DOMContentLoaded', function() {
        applyLanguage();
    });

    let map;
    let markers = [];
    let directionsService;
    let directionsRenderer;
    let userMarker;
    let autocomplete;
    let markerCluster;
    let accessibleLocations = [];

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 32.5556, lng: 35.85 }, // Center on Irbid, Jordan (example)
            zoom: 13,
            fullscreenControl: true,
            streetViewControl: false,
            mapTypeControl: false,
            gestureHandling: 'greedy'
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ map: map, panel: document.getElementById('directions-panel') });

        // Initialize autocomplete for search input
        const input = document.getElementById('search-input');
        autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);

        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                alert(currentLang === 'ar' ? "لم يتم العثور على المكان: '" + place.name + "'" : "Place not found: '" + place.name + "'");
                return;
            }

            // Center map on selected place
            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(15);
            }

            // Clear existing markers except accessible locations and user marker
            clearSearchMarkers();

            // Add marker for selected place
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                title: place.name,
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                }
            });
            markers.push(marker);

            // Optionally, calculate directions from user location to this place if user location known
            if (userMarker) {
                calculateAndDisplayRoute(userMarker.getPosition(), place.geometry.location);
            }
        });

        loadAccessibleLocations();

        // Setup locate button to get user location
        document.getElementById('locate-btn').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Remove previous user marker if any
                    if (userMarker) {
                        userMarker.setMap(null);
                    }

                    userMarker = new google.maps.Marker({
                        position: pos,
                        map: map,
                        title: currentLang === 'ar' ? "موقعي الحالي" : "My Location",
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#4285F4',
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: 'white'
                        }
                    });

                    map.setCenter(pos);
                    map.setZoom(14);
                }, () => {
                    alert(currentLang === 'ar' ? 'تعذر الحصول على موقعك.' : 'Failed to get your location.');
                });
            } else {
                alert(currentLang === 'ar' ? 'المتصفح لا يدعم تحديد الموقع.' : 'Browser does not support location.');
            }
        });
    }

    function loadAccessibleLocations() {
        const loadingDiv = document.getElementById('loading');
        loadingDiv.style.display = 'block';

        fetch('/api/accessible_locations')
            .then(response => response.json())
            .then(data => {
                loadingDiv.style.display = 'none';
                if (data.locations) {
                    accessibleLocations = data.locations;
                    applyFiltersAndDisplay();
                } else {
                    alert(currentLang === 'ar' ? 'لم يتم العثور على مراكز الدعم.' : 'No support centers found.');
                }
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                console.error('Error fetching accessible locations:', error);
                alert(currentLang === 'ar' ? 'حدث خطأ أثناء تحميل المراكز.' : 'Error loading centers.');
            });
    }

    function addAccessibleMarkers(locations) {
        clearAccessibleMarkers();

        markers = markers.filter(m => m !== userMarker); // Keep user marker if exists

        const iconBase = "http://maps.google.com/mapfiles/ms/icons/";
        const iconUrl = iconBase + "red-dot.png";

        locations.forEach(location => {
            const marker = new google.maps.Marker({
                position: { lat: location.latitude, lng: location.longitude },
                map: map,
                title: location.name,
                icon: iconUrl
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<h3>${location.name}</h3><p>${location.address}</p><p>${currentLang === 'ar' ? 'الميزات' : 'Features'}: ${location.features.join(', ')}</p><p>${currentLang === 'ar' ? 'نوع الإعاقة' : 'Disability Type'}: ${location.type}</p>`
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            markers.push(marker);
        });

        // Add marker clustering
        if (markerCluster) {
            markerCluster.clearMarkers();
        }
        markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
    }

    function clearAccessibleMarkers() {
        markers.forEach(marker => {
            if (marker !== userMarker) {
                marker.setMap(null);
            }
        });
        markers = userMarker ? [userMarker] : [];
        if (markerCluster) {
            markerCluster.clearMarkers();
        }
    }

    function clearSearchMarkers() {
        // Remove all markers except accessible locations and user marker
        markers.forEach(marker => {
            if (marker !== userMarker && !accessibleLocations.some(loc => loc.latitude === marker.getPosition().lat() && loc.longitude === marker.getPosition().lng())) {
                marker.setMap(null);
            }
        });
        markers = markers.filter(marker => marker === userMarker || accessibleLocations.some(loc => loc.latitude === marker.getPosition().lat() && loc.longitude === marker.getPosition().lng()));
    }

    function populateSidebar(locations) {
        const list = document.getElementById('locations-list');
        list.innerHTML = '';
        locations.forEach((location, index) => {
            const li = document.createElement('li');
            li.textContent = location.name + ' - ' + location.address;
            li.addEventListener('click', () => {
                map.setCenter({ lat: location.latitude, lng: location.longitude });
                map.setZoom(15);
                google.maps.event.trigger(markers.find(m => m.getPosition().lat() === location.latitude && m.getPosition().lng() === location.longitude), 'click');
            });
            list.appendChild(li);
        });
    }

    function calculateAndDisplayRoute(origin, destination) {
        directionsService.route(
            {
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            },
            (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    alert(currentLang === 'ar' ? 'فشل عرض المسار: ' + status : 'Failed to display route: ' + status);
                }
            }
        );
    }
    // New function to get selected disability filters
    function getSelectedDisabilityFilters() {
        const checkboxes = document.querySelectorAll('.disability-filter');
        const selected = [];
        checkboxes.forEach(cb => {
            if (cb.checked) {
                selected.push(cb.value);
            }
        });
        return selected;
    }

    // Apply filters and update markers and sidebar
    function applyFiltersAndDisplay() {
        const selectedTypes = getSelectedDisabilityFilters();

        const filteredLocations = accessibleLocations.filter(loc => {
            // loc.type can be a comma-separated string or a single type
            if (!loc.type) return false;
            const locTypes = loc.type.toLowerCase().split(',').map(t => t.trim());
            return locTypes.some(t => selectedTypes.includes(t));
        });

        addAccessibleMarkers(filteredLocations);
        populateSidebar(filteredLocations);
    }

    // Add event listeners to filter checkboxes
    document.querySelectorAll('.disability-filter').forEach(cb => {
        cb.addEventListener('change', () => {
            applyFiltersAndDisplay();
        });
    });

</script>
{% endblock %}
